<!DOCTYPE html>
<html>
    <head>
        <style>
            html, body {
                margin: 0;
                padding: 0;
            }
            .game-container {
                position: absolute;
                width: 100vw;
                height: 100vh;
                left: 0vw;
                top: 0vh;
                overflow: hidden;
            }
            .background {
                position: absolute;
                width: 100000%;
                height: 100%;
                left: 0;
                top: 0;
                background-size: contain;
                background-repeat: repeat-x;
                background-image: url("background.png");
                z-index: -2;
            }
            .foreground {
                position: absolute;
                width: 100000%;
                height: 32.2916667%;
                left: 0;
                bottom: 0;
                z-index: -1;
                background-size: contain;
                background-repeat: repeat-x;
                background-image: url("foreground.png");
            }
            .layer1-wrapper {
                position: absolute;
                bottom: 18vh;
                left: 22vw;
                width: 100%;
                height: 100%;
            }
            .layer1 {
                position: absolute;
                width: 100%;
                height: 100%;
            }
            .player {
                position: absolute;
                width: 160px;
                height: 200px;
                transform: translate(-50%, 20%);
            }
            .player-frame {
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
                background-size: contain;
                background-position: center;
                background-repeat: no-repeat;
            }
            .player-frame-jump {
                background-image: url("player/jump.png");
            }

            .obstacle {
                position: absolute;
                width: 160px;
                height: 160px;
                transform: translate(-50%, 50%);
                bottom: 0;
                background-size: contain;
                background-position: center;
                background-repeat: no-repeat;
            }
            .obstacle-log {
                background-image: url("obstacles/Tree\ Log.png");
            }
            .obstacle-rocks {
                background-image: url("obstacles/Rocks.png");
            }
            .obstacle-water {
                background-image: url("obstacles/Water.png");
            }
            .obstacle-bush {
                background-image: url("obstacles/Bush.png");
            }

            .item {
                position: absolute;
                width: 80px;
                height: 80px;
                transform: translate(-50%, 50%);
                background-size: contain;
                background-position: center;
                background-repeat: no-repeat;
            }
            .item-bangle {
                background-image: url("items/Gold\ Bangle.png");
            }
            .item-necklace {
                background-image: url("items/Gold\ Necklace.png");
            }
            .item-ring {
                background-image: url("items/Gold\ Ring.png");
            }


            .points {
                position: absolute;
                top: 48px;
                right: 48px;
                font-size: 96px;
                font-family: cursive;
                font-weight: 700;
                color: white;
            }

            .start-overlay, .death-overlay, .pause-overlay {
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;
                background-color: black;
                opacity: 0.7;

                color: white;
                font-size: 6vh;
                font-family: cursive;

                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
            }

            .fb-share-button-wrapper {
                position: absolute;
                top: 2vh;
                left: 2vh;
            }

            @media only screen and (max-width: 1000px) {
                .player {
                    width: 120px;
                    height: 160px;
                }
                .obstacle {
                    width: 100px;
                    height: 100px;
                }
            }
        </style>
    </head>
    <body>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <div class="game-container">
            <div class="background"></div>
            <div class="foreground"></div>
            <div class="layer1-wrapper">
                <div class="layer1">
                    <div class="player">
                        <div class="player-frame player-frame-jump"></div>
                    </div>
                    <div class="obstacles-container">
        
                    </div>
                    <div class="items-container">
    
                    </div>
                </div>
            </div>
            <div class="points">

            </div>

            <div class="start-overlay">
                Press anywhere to start
            </div>
            <div class="pause-overlay">
                Paused
                <br>
                Press p to unpause
            </div>
            <div class="death-overlay">
                You crashed!
                <br>
                Press anywhere to play again
            </div>

            
            <!-- facebook share button -->
            <div class="fb-share-button-wrapper">
                <div class="fb-share-button" 
                data-href="https://www.fiverr.com/jupunsupun" 
                data-layout="button_count">
                </div>
            </div>
        </div>
        <audio class="music" loop>
            <source src="music.mp3" type="audio/mpeg">
        </audio>

        <div id="fb-root"></div>
        <script>(function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.0";
        fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));</script>


        <script>
            $(".death-overlay").hide();
            $(".pause-overlay").hide();

            let renderCounter = 0;
            const intervalLoopsPerRender = 5;

            let player;
            const gravity = 0.2;
            const jumpInitialVY = 10;

            //must be multiple of 2
            const playerFrameBreakpoint = 16;
            const playerFrames = 4;
            for(let i=0; i<playerFrames; i++) {
                $(".player").append(`<div class="player-frame player-frame-${i}" style="background-image: url('player/run${i}.png')">`);
            }

            let obstacles;
            const obstacleWidth = 60;
            let obstacleTypes = ["log", "rocks", "water", "bush"];
            let obstacleDist = [600, 600, 1000, 1000, 1600];
            let prevObstacleX;
            let obstacleIdCounter;

            let backgroundX;
            const backgroundVX = 1;

            let items;
            const itemWidth = 60;
            const itemHeight = 100;
            const itemsY = 200;
            let prevItemX;
            let itemIdCounter;
            let itemTypes = ["bangle", "bangle", "bangle", "bangle", "necklace", "ring", "ring", "ring", "ring"];
            let itemDist = [200, 1000, 1600, 1600, 2000, 2400];

            let points;

            restart();

            

            $(document).on("keydown", (e) => {
                //p
                if(e.which == 80) {
                    togglePause();
                }
            });
            $(document).on("mousedown", () => {
                //do same thing as pressing w
                //unpause
                if(paused) {
                    //unpause
                    togglePause();
                }
                //jump
                if(!player.jumping) {
                    player.vy = jumpInitialVY;
                    player.jumping = true;
                    $(".player-frame").hide();
                    $(".player-frame-jump").show();
                }
            });

            function render() {
                $(".layer1").css("left", -player.x);
                $(".foreground").css("left", -player.x);

                //player
                $(".player").css("left", player.x);
                $(".player").css("bottom", player.y);
                if(player.frameCounter % playerFrameBreakpoint == 0 && !player.jumping) {
                    $(".player-frame").hide();
                    $(`.player-frame-${Math.floor(player.frameCounter/playerFrameBreakpoint)}`).show();
                }

                //background
                //$(".background").css("left", backgroundX);

                //points
                $(".points").html(points);
            }

            let interval;
            let paused = true;
            function togglePause() {
                if(!paused) {
                    clearInterval(interval);
                    paused = true;
                    $(".pause-overlay").show();
                    $(".music").get(0).pause();
                }
                else {
                    startInterval();
                    paused = false;
                    $(".start-overlay").hide();
                    $(".death-overlay").hide();
                    $(".pause-overlay").hide();
                    $(".music").get(0).play();
                }
            }
            function startInterval() {
                let prevDate = Date.now();
                interval = setInterval(() => {
                    //update player
                    if(player.boost >= 0) {
                        player.boost--;
                        if(player.boost == -1) {
                            player.vx = 5;
                        }
                    }
                    player.x += player.vx;
                    player.y += player.vy;
                    if(player.jumping) player.vy -= gravity;
                    if(player.y < 0) {
                        player.y = 0;
                        player.jumping = false;
                        $(".player-frame").hide();
                        $(`.player-frame-${Math.floor(player.frameCounter/playerFrameBreakpoint)}`).show();
                    }
                    
                    player.scoreCounter++;
                    if(player.scoreCounter % 50 == 0) points++;

                    if(player.boost >= 0) player.frameCounter+=2;
                    else player.frameCounter++;
                    if(player.frameCounter >= playerFrames * playerFrameBreakpoint) player.frameCounter = 0;

                    //flashing near end of boost
                    if(player.boost <= 200) {
                        if(player.boost % 20 == 10) $(".player").hide();
                        if(player.boost % 20 == 0) $(".player").show();
                    }

                    //obstacle/item gen
                    while(items.length == 0 || items[items.length-1].x < player.x + 4000) createItem();
                    while(obstacles.length == 0 || obstacles[obstacles.length-1].x < player.x + 4000) createObstacle();
                    
                    //obstacle collision
                    for(let obstacle of obstacles) {
                        if(player.y <= obstacleWidth && player.boost == -1 && Math.abs(obstacle.x - player.x) <= obstacleWidth) {
                            lose();
                        }
                        if(obstacle.x < player.x - 4000) removeObstacle();
                    }

                    //item collision
                    for(let item of items) {
                        if(item.active && Math.abs(item.x - player.x) <= itemWidth && Math.abs(itemsY - player.y) <= itemHeight) {
                            if(item.type == "necklace") {
                                player.boost = 500;
                                player.vx = 12;
                                $(".player").show(); //in case the player was hidden previously when flashing
                            }
                            points += 5;
                            item.active = false;
                            $(`.item-${item.id}`).hide();
                        }
                        if(item.x < player.x - 4000) removeItem();
                    }
                    

                    //update background
                    backgroundX -= backgroundVX;

                    renderCounter++;
                    if(renderCounter % intervalLoopsPerRender == 0) render();

                    if(renderCounter % 100 == 0) {
                        console.log(Date.now() - prevDate);
                        prevDate = Date.now();
                    }
                    console.log(renderCounter);
                },10);
            }

            function createItem() {
                let newItemX = prevItemX + itemDist[Math.floor(Math.random() * itemDist.length)];
                let type = itemTypes[Math.floor(Math.random() * itemTypes.length)];
                items.push({x: newItemX, type: type, active: true, id: itemIdCounter});
                $(".items-container").append(`<div class="item item-${type} item-${itemIdCounter}" style="left: ${newItemX}px; bottom: ${itemsY}px"></div>`);
                prevItemX = newItemX;
                itemIdCounter++;
            }
            function removeItem() {
                let removedItem = items.shift();
                $(`.item-${removedItem.id}`).remove();
            }
            function createObstacle() {
                let newObstacleX = prevObstacleX + obstacleDist[Math.floor(Math.random() * obstacleDist.length)];
                let type = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];
                obstacles.push({x: newObstacleX, type: type, id: obstacleIdCounter});
                $(".obstacles-container").append(`<div class="obstacle obstacle-${type} obstacle-${obstacleIdCounter}" style="left: ${newObstacleX}px"></div>`);
                obstacleIdCounter++;
                prevObstacleX = newObstacleX;
            }
            //TODO
            function removeObstacle() {
                let removedObstacle = obstacles.shift();
                $(`.obstacle-${removedObstacle.id}`).remove();
            }
            

            function restart() {
                player = {
                    x: 0,
                    y: 0,
                    vx: 5,
                    vy: 0,
                    jumping: false,
                    frameCounter: 0,
                    boost: -1,
                    scoreCounter: 0,
                }
                backgroundX = 0;
                points = 0;

                obstacles = [];
                prevObstacleX = 600;
                obstacleIdCounter = 0;
                $(".obstacles-container").empty();

                items = [];
                itemIdCounter = 0;
                $(".items-container").empty();
                prevItemX = 1000;

                render();
            }
            function lose() {
                $(".death-overlay").show();
                togglePause();
                $(".pause-overlay").hide();
                restart();
            }
        </script>
    </body>
</html>